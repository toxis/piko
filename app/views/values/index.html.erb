<div class="row" style="padding-top: 20px;">
  <div class="col-md-10">
  	<img src="http://ingenierie.he-arc.ch/sites/all/themes/Ingenierie/css/img/ING_HE-ARC_logo.jpg" class="img-responsive" />
  </div>
  <div class="col-md-2">
  	<strong>Échelle:</strong>
  	<div class="input-group input-append dropdown combobox" data-initialize="combobox" id="cbxData">
	  <input type="text" class="form-control">
	  <div class="input-group-btn">
	    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><span class="caret"></span></button>
	    <ul class="dropdown-menu dropdown-menu-right">
	      <li data-value="hourly" data-selected="true"><a href="#">1h (temps réel)</a></li>
	      <li data-value="daily"><a href="#">1 jour</a></li>
	      <li data-value="weekly"><a href="#">1 semaine</a></li>
	      <li data-value="monthly"><a href="#">1 mois (TODO)</a></li>
	      <li data-value="yearly"><a href="#">1 année (TODO)</a></li>
	    </ul>
	  </div>
	</div>
  </div>
</div>

<div class="row">
  <div class="col-md-12">
  	<h3><%= @title %></h3>
  	<div id="graph"></div>
  </div>
</div>

<div class="row">
  <div class="col-md-3">
  	<h4>Valeur maximale</h4>
  	<a href="#" id="btnMax" class="btn btn-lg btn-success btn-block" role="button" data-toggle="popover" data-html="true" data-trigger="focus" title="<strong>Valeurs maximales</strong>" data-content="Chargement...">...</a>	
  </div>
  <div class="col-md-1"></div>
  <div class="col-md-3">
  	<h4>Valeur moyenne</h4>
    <a href="#" id="btnAverage" class="btn btn-lg btn-primary btn-block" role="button" data-toggle="popover" data-html="true" data-trigger="focus" title="<strong>Valeurs moyennes</strong>" data-content="Chargement...">...</a>	
  </div>
  <div class="col-md-1"></div>
  <div class="col-md-3">
  	<h4>Valeur minimale</h4>
  	<a href="#" id="btnMin" class="btn btn-lg btn-warning btn-block" role="button" data-toggle="popover" data-html="true" data-trigger="focus" title="<strong>Valeurs minimales</strong>" data-content="Chargement...">...</a>	
  </div>
  <div class="col-md-1"></div>
</div>

<script type="text/javascript">
  function drawChart(data) {
  	Highcharts.setOptions({
	  lang: {
	    decimalPoint: '.',
        thousandsSep: "'",
	  }
	});
  	
  	var chart = $('#graph').highcharts('StockChart', {
  	  rangeSelector: {
  	  	enabled: false
  	  },
  	  navigator: {
  	    enabled: false
  	  },
  	  series: data
    });
    <% if params[:period] && params[:period] == 'hourly' %>
      setInterval(function(){
        addLastPoint();
      }, 60000);
    <% end %>
  }
  
  function addLastPoint() {
  	$.ajax({
  	  type: 'GET',
  	  url: 'api/lastpoint?<%= @json_params.to_query %>'
  	}).done(function(data){
      var i, j, series = $('#graph').highcharts().series;
      for(i = 0; i < data.length; i++) {
      	for(j = 0; j < series.length; j++) {
      	  if (series[j].name == data[i].name) {
      	  	series[j].addPoint(data[i].data, true, true);
      	  }
      	}
      }
  	});
  }
  
  function showStats(stats) {
  	var max = '', min = '', average = '', i = 0;
  	
  	$('#btnMax').text(stats[i].max + ' W');
  	$('#btnMin').text(stats[i].min + ' W');
  	$('#btnAverage').text(stats[i].average + ' W');
  	
  	for (i; i < stats.length; i++) {
  	  max += stats[i].name + ': <span class="label label-success" style="float:right">' + stats[i].max + ' W</span><br/>';
  	  min += stats[i].name + ': <span class="label label-warning" style="float:right">' + stats[i].min + ' W</span><br/>';
  	  average += stats[i].name + ': <span class="label label-primary" style="float:right">' + stats[i].average + ' W</span><br/>';
  	}
  	
  	$('#btnMax').attr('data-content', max);
  	$('#btnMin').attr('data-content', min);
  	$('#btnAverage').attr('data-content', average);
  	
  	$('[data-toggle="popover"]').popover({
      trigger: 'hover',
      placement: 'bottom'
    });
  }
  
  $(function(){
  	$.ajax({
	  type: 'GET',
	  url: 'api/values?<%= @json_params.to_query %>'
	}).done(function(data){
	  drawChart(data.data);
	  showStats(data.statistics);
	});
	
	<% if params[:period] %>
	  $('#cbxData').combobox('selectByValue', '<%= params[:period] %>');
	<% end %>
	$('.combobox').on('changed.fu.combobox', function (evt, data) {
	  window.location.href = '/?period=' + $('#cbxData').combobox('selectedItem').value;
	});
  });
  
</script>
